#!/bin/bash
# Title: HVA - HTML Video Automator
# Author: Loïc Cattani "arko" <loic.cattani@gmail.com>
# Begin: 2011.01.28
#
# Ce script automatise l'encodage et la préparation du code HTML pour
# une ou plusieurs vidéos déposées dans une boîte de dépôt.
#
# Il est prévu pour être executé automatiquement par launchd lorsque
# la boîte de dépôt est modifiée.

# Config files
config_file="hva.conf"
prod_config_file="/etc/hva.conf"

# Load config file and set environment
if [[ -e $config_file ]]; then
  env="dev"
elif [[ -e $prod_config_file ]]; then
  config_file=$prod_config_file
  env="prod"
else
  echo "Can't find config file! Exiting..."
  exit 1
fi
source $config_file
# Keep in mind this is not secure. As one may add nasty code in
# config file! It should only be writable by owner.

# Log messages to log file
function log () {
  echo "$(date) - $1" >> $log_file
}

# Log ffmpeg messages to log file
function ffmpeg_log () {
  echo -e "#### $(date) - $1\n" >> $ffmpeg_log_file
}

log "HTML Video Automator started"

# Lock HVA execution (MUTEX)
mkdir /tmp/hva-lock 2> /dev/null
if [[ $? != 0 ]]; then
  log "HVA already running. Exiting..."
  exit 0
fi

# Get all files in launchpad (Assumed they are all video files)
# If not, we'll see what happens... ffmpeg can read nearly everything
files=($(find $launchpad/*))

log "${#files[@]} files found in $launchpad"

for file in ${files[@]}; do
  
  # Getting filename without extension
  file_basename=$(basename $file)
  file_name=${file_basename%.*}
  
  # Setting encoded filename
  outfile="${file_name}.mp4"
  
  log "Processing $file_basename"
  
  #Encoding H.264
  ffmpeg_log "Encoding $file"
  ffmpeg -y -i $file -threads 0 -f mp4 -vcodec libx264 -vpre slow -vpre ipod640 -b 1200k -acodec libfaac -ab 160000 -ac 2 -s 640x480 $payload/$outfile 2>> $ffmpeg_log_file
  ffmpeg_log "Finished encoding $file"
  
  log "Finished encoding $outfile"
  
  # TODO:
  # Encode webm
  # Build HTML document
  # scp encoded movies and html doc to www server
  # scp source movies to archive server
  # Clean local files
  
done

log "Done."

# Unlock
rm -r /tmp/hva-lock

exit 0
